<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Личный кабинет — Автомастерская</title>
  <meta name="description" content="Личный кабинет клиента автосервиса: история записей, статус ремонта, данные автомобиля, профиль." />

  <!-- Те же шрифты и стили, что на главной -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/style.css">
  <link rel="stylesheet" href="styles/cabinet.css">
</head>

<body>
  <a class="skip" href="#main">К основному содержимому</a>

  <!-- Шапка такая же, как на главной, только активна иконка кабинета -->
  <header>
    <div class="container topbar" role="banner">
      <a href="auto.html" class="brand" aria-label="Перейти на главную страницу">
  <span class="brand__logo" aria-hidden="true">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="34" height="40" fill="#e11d48">
      <path d="M22.5,14H1.5a7.109,7.109,0,0,1,.423-.88L3.98,9.52A5.013,5.013,0,0,1,8.321,7h7.358A5.011,5.011,0,0,1,20.02,9.52l2.057,3.6A7.116,7.116,0,0,1,22.5,14ZM19,16v1a1,1,0,0,1-2,0V16H7v1a1,1,0,0,1-2,0V16H1.026Q1,16.3,1,16.594V18a4,4,0,0,0,2,3.463V22a2,2,0,0,0,4,0H17a2,2,0,0,0,4,0v-.537A4,4,0,0,0,23,18V16.594q0-.3-.026-.594ZM23,4H22a1,1,0,0,1,0-2h1c.673,0,.625-.448.493-.649A3.015,3.015,0,0,0,18.167,2H5.845A3.015,3.015,0,0,0,.519,1.351C0,2.283,1.926,1.939,2.012,2a1,1,0,0,1,0,2h-1c-.673,0-.625.448-.493.649A3.015,3.015,0,0,0,5.845,4H18.167a3.015,3.015,0,0,0,5.326.649C23.625,4.448,23.673,4,23,4Z"/>
    </svg>
  </span>
  <span class="brand__name">Автомастерская</span>
</a>

      <nav aria-label="Основная навигация">
        <ul>
          <li><a class="nav__link" href="auto.html#services">Услуги</a></li>
          <li><a class="nav__link" href="auto.html#pricing">Цены</a></li>
          <li><a class="nav__link" href="auto.html#booking">Бронирование</a></li>
          <li><a class="nav__link" href="auto.html#reviews">Отзывы</a></li>
          <li><a class="nav__link" href="auto.html#contacts">Контакты</a></li>
        </ul>
      </nav>

      <div class="actions" role="group" aria-label="Действия">
        <a href="tel:+375290000000" class="actions__icon" aria-label="Позвонить">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1v3.49c0 .55-.45 1-1 1C9.25 21 3 14.75 3 7.5c0-.55.45-1 1-1H7.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
        </a>
        <a href="auto.html#booking" class="actions__icon" aria-label="Записаться">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        </a>
        <a href="cabinet.html" class="actions__icon" aria-label="Личный кабинет" id="cabinet-link">
          <!-- По умолчанию иконка профиля -->
          <svg xmlns="http://www.w3.org/2000/svg" fill="white" viewBox="0 0 24 24">
            <path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/>
          </svg>
        </a>
      </div>
    </div>
  </header>

  <main id="main" tabindex="-1" style="padding-top: 3rem; padding-bottom: 4rem; background: var(--bg); min-height: 80vh;">
    <div class="container">

      <!-- Приветствие — будет заполняться динамически -->
      <section class="grid grid--2" style="align-items: center; margin-bottom: 3rem; gap: 2rem;">
        <div class="profile-avatar" id="user-avatar">?</div>
        <div>
          <h1 style="margin:0; font-size: 2rem;" id="welcome-name">Загрузка...</h1>
          <p style="color:var(--muted); margin: 0.5rem 0 0;" id="user-contact">• • •</p>
        </div>
      </section>

    <!-- Статистика — тоже динамически -->
    <div class="grid grid--4" style="margin-bottom: 3rem; gap: 1rem;">
      <div class="card" style="text-align:center; padding:1.5rem;">
        <strong style="font-size:2rem; color:var(--primary);" id="active-count">0</strong><br>
        <span style="color:var(--muted);">Активные заказы</span>
      </div>  
      <div class="card" style="text-align:center; padding:1.5rem;">
        <strong style="font-size:2rem; color:#16a34a;" id="completed-count">0</strong><br>
        <span style="color:var(--muted);">Завершённые заказы</span>
      </div>
      <div class="card" style="text-align:center; padding:1.5rem; cursor:pointer;" id="my-cars-card">
    <strong style="font-size:2rem; color:#2563eb;" id="cars-count">0</strong><br>
    <span style="color:var(--muted);">Мои авто</span>
  </div>
      <div class="card" style="text-align:center; padding:1.5rem;">
        <strong style="font-size:2rem; color:#dc2626;" id="rejected-count">0</strong><br>
        <span style="color:var(--muted);">Отказанные заказы</span>
      </div>
    </div>
<section style="margin-bottom: 4rem;">
  <h2 style="margin-bottom: 1.5rem;">Мои автомобили</h2>
  <div id="cars-container" class="grid grid--3" style="gap: 1.5rem;">
    <div class="card" style="display:flex;align-items:center;justify-content:center;cursor:pointer;min-height:140px;border:2px dashed var(--border);" id="add-car-btn">
      <span style="font-size:4rem;color:var(--muted);font-weight:200;">+</span>
    </div>
  </div>
</section>
      <!-- Текущие записи — будут подгружаться из базы -->
      <section style="margin-bottom: 4rem;">
        <h2 style="margin-bottom: 1.5rem;">Текущие и предстоящие записи</h2>
        <div id="appointments-list" class="grid grid--1" style="gap: 1rem;">
          <p style="text-align:center; color:var(--muted);">Загрузка ваших записей...</p>
        </div>

        <p style="text-align:center; margin-top:2rem;">
          <a href="auto.html#booking" class="btn btn--primary">Записаться на новую услугу</a>
        </p>
      </section>
    </div>
  </main>

  <!-- Футер такой же -->
  <footer>
    <div class="container footer__cols" role="contentinfo">
      <div class="footer__brand">
        <strong>Автомастерская</strong>
        <p>Надёжный сервис с прозрачными ценами и гарантией на работы.</p>
      </div>
      <nav aria-label="Служебная навигация">
        <ul style="list-style:none; padding:0; margin:0; display:grid; gap:8px">
          <li><a href="auto.html#services">Услуги</a></li>
          <li><a href="auto.html#pricing">Цены</a></li>
          <li><a href="auto.html#booking">Бронирование</a></li>
          <li><a href="auto.html#reviews">Отзывы</a></li>
          <li><a href="auto.html#contacts">Контакты</a></li>
          <li><a href="auto.html#contacts">Контакты</a></li>
        </ul>
      </nav>
      <div>
        <small>© 2025 — ИП «Автомастерская»<br>ИНН 0000000000 · ОГРНИП 000000000000000</small>
      </div>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const getCookie = name => (document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)')?.pop() || null);
      const userId = getCookie('user');

      if (!userId) {
        alert('Вы не авторизованы');
        window.location.href = 'auth.html';
        return;
      }

      try {
        // Получаем пользователя
        const userRes = await fetch(`/api/user?id=${userId}`);
        const user = await userRes.json();

        document.getElementById('welcome-name').textContent = `Добро пожаловать, ${user.name}!`;
        document.getElementById('user-contact').textContent = user.email;
        document.getElementById('user-avatar').textContent = user.name.split(' ').map(n => n[0]).join('').slice(0,2).toUpperCase();

        // Получаем ВСЕ записи и фильтруем по user_id
        const apptRes = await fetch('/api/appointments');
        const allAppointments = await apptRes.json();
        const myAppointments = allAppointments.filter(a => a.user_id == userId);

    // Статистика
    const activeAppointments = myAppointments.filter(a => 
      !['ready', 'completed', 'rejected'].includes(a.status)
    );
    const completedAppointments = myAppointments.filter(a => 
      ['ready', 'completed'].includes(a.status)
    );
    const rejectedAppointments = myAppointments.filter(a => 
      a.status === 'rejected'
    );

    document.getElementById('active-count').textContent = activeAppointments.length;
    document.getElementById('completed-count').textContent = completedAppointments.length;
    document.getElementById('rejected-count').textContent = rejectedAppointments.length;

// Завершённые визиты — только "Готово к выдаче" и "Выполнено"
// Отказано — НЕ считается завершённым!
document.getElementById('completed-count').textContent = myAppointments.filter(a => 
  a.status === 'ready' || 
  a.status === 'completed'
).length;

    // Рендер записей
    const list = document.getElementById('appointments-list');
    list.innerHTML = myAppointments.length === 0 
      ? '<p style="text-align:center; color:var(--muted);">У вас пока нет записей</p>'
      : '';

        myAppointments.forEach(a => {
  const date = new Date(a.date + 'T' + a.time);
  const formatted = date.toLocaleString('ru-RU', { 
    day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' 
  });

  const statusInfo = {
    pending: ['Ожидает', 'status--waiting'],
    'in-progress': ['В работе', 'status--in-progress'],
    rejected: ['Отказано', 'status--rejected'],
    ready: ['Готово к выдаче', 'status--ready'],
    completed: ['Выполнено', 'status--completed']
  }[a.status] || ['Ожидает', 'status--waiting'];

  // === Блок отзыва ===
  let reviewBlock = '';

  if (['ready', 'completed'].includes(a.status)) {
    if (a.review_text) {
      // Отзыв уже оставлен — показываем его
      const stars = '★'.repeat(a.rating || 0) + '☆'.repeat(5 - (a.rating || 0));
      const reviewDate = a.review_date ? new Date(a.review_date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
      reviewBlock = `
        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
          <strong>Ваш отзыв:</strong><br>
          <div class="stars" aria-hidden="true" style="font-size:1.2rem; color:#fbbf24;">${stars}</div>
          <p style="margin: 0.5rem 0; color: var(--text);">${a.review_text}</p>
          <small style="color: var(--muted);">Оставлен ${reviewDate}</small>
        </div>
      `;
    } else {
      // Форма для оставления отзыва
      reviewBlock = `
        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
          <strong>Оставить отзыв</strong>
          <form class="review-form" data-id="${a.id}">
            <div style="margin: 0.8rem 0;">
              <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Рейтинг:</label>
              <select name="rating" required style="width:100%; padding:0.6rem; border-radius:6px; border:1px solid var(--border);">
                <option value="" disabled selected>Выберите рейтинг</option>
                <option value="5">★★★★★ Отлично</option>
                <option value="4">★★★★☆ Хорошо</option>
                <option value="3">★★★☆☆ Нормально</option>
                <option value="2">★★☆☆☆ Плохо</option>
                <option value="1">★☆☆☆☆ Ужасно</option>
              </select>
            </div>
            <div style="margin: 0.8rem 0;">
              <label style="display:block; margin-bottom:0.4rem; font-weight:600;">Ваш отзыв:</label>
              <textarea name="text" rows="4" placeholder="Расскажите о вашем опыте..." required 
                        style="width:100%; padding:0.6rem; border-radius:6px; border:1px solid var(--border); resize:vertical;"></textarea>
            </div>
            <button type="submit" class="btn btn--primary" style="width:100%;">Отправить отзыв</button>
          </form>
        </div>
      `;
    }
  }

  list.innerHTML += `
    <article class="card" style="padding:1.5rem; display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; gap:1rem;">
      <div style="flex:1;">
        <strong>${a.car || 'Автомобиль не указан'}</strong><br>
        <time>${formatted}</time> • ${a.service}
        ${a.comment ? `<br><small style="color:var(--muted);">${a.comment}</small>` : ''}
        ${reviewBlock}
      </div>
      <div style="text-align:right;">
        <span class="status ${statusInfo[1]}">${statusInfo[0]}</span>
      </div>
    </article>
  `;
});

// Обработчик отправки отзывов
document.querySelectorAll('.review-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const button = form.querySelector('button[type="submit"]');
    const oldText = button.textContent;
    button.disabled = true;
    button.textContent = 'Отправка...';

    const formData = new FormData(form);
    const params = new URLSearchParams();
    params.append('id', form.dataset.id);
    params.append('text', formData.get('text').trim());
    params.append('rating', formData.get('rating'));

    try {
      const res = await fetch('/api/review', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
      });

      if (res.ok) {
        alert('Спасибо за ваш отзыв! Он появится на главной странице после модерации.');
        location.reload(); // Обновляем кабинет, чтобы показать отзыв
      } else {
        const error = await res.text();
        alert('Ошибка отправки отзыва: ' + error);
      }
    } catch (err) {
      alert('Нет связи с сервером. Попробуйте позже.');
    } finally {
      button.disabled = false;
      button.textContent = oldText;
    }
  });
});
        // === Мои автомобили ===
      const carsRes = await fetch(`/api/cars?user_id=${userId}`);
      const cars = await carsRes.json();
      document.getElementById('cars-count').textContent = cars.length;

      const container = document.getElementById('cars-container');

      cars.forEach(car => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.cssText = 'padding:1.5rem;position:relative;';
        div.innerHTML = `
          <button style="position:absolute;top:8px;right:12px;background:none;border:none;font-size:1.8rem;cursor:pointer;opacity:0.7;color:#9aa3af;" 
                  data-id="${car.id}">×</button>
          <strong>${car.brand} ${car.model}</strong><br>
          <small style="color:var(--muted);">${car.year} г.</small>
        `;
        container.insertBefore(div, document.getElementById('add-car-btn'));
      });

      // Кнопка добавления
      document.getElementById('add-car-btn').onclick = () => 
        document.getElementById('car-modal').style.display = 'flex';

      document.getElementById('cancel-car').onclick = () => 
        document.getElementById('car-modal').style.display = 'none';

      document.getElementById('car-form').onsubmit = async e => {
        e.preventDefault();
        const fd = new FormData(e.target);
        await fetch('/api/car', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(fd)
        });
        location.reload();
      };

      // Удаление
      document.querySelectorAll('#cars-container button[data-id]').forEach(btn => {
        btn.onclick = async () => {
          if (confirm('Удалить автомобиль?')) {
            await fetch(`/api/car/${btn.dataset.id}`, { method: 'DELETE' });
            location.reload();
          }
        };
      });

      } catch (err) {
        console.error(err);
        alert('Ошибка соединения с сервером');
      }
    });

    // Выход
    document.getElementById('cabinet-link')?.addEventListener('click', e => {
      // Если мы на странице cabinet.html — выходим
      if (window.location.pathname.includes('cabinet.html')) {
        e.preventDefault();
        document.cookie = 'user=; Max-Age=0; path=/';
        window.location.replace('auto.html');
      }
      // иначе просто переход в кабинет или на auth.html (по href)
    });
  </script>
<!-- Модальное окно добавления авто -->
<div id="car-modal" style="display:none; position:fixed; inset:0; background:rgba(13, 15, 18, 0.9); z-index:100; 
      flex-direction:column; align-items:center; justify-content:center;">
  
  <div style="width:100%; max-width:380px; background:#12161b; padding:2rem; border-radius:24px; 
              box-sizing:border-box; box-shadow:0 20px 25px -5px rgba(30, 27, 27, 0.3);">
    
    <h3 style="color:var(--text); font-size:1.5rem; margin-bottom:1.5rem; text-align:center;">
      Добавить автомобиль
    </h3>
    
    <form id="car-form">
      <!-- Марка -->
      <div style="margin-bottom:1rem;">
        <label style="color:var(--muted); font-size:0.875rem; margin-bottom:0.5rem; display:block;">Марка</label>
        <input type="text" name="brand" placeholder="Марка" required 
               style="width:100%; padding:1rem; background: #0d0f12; border:1px solid var(--border)  ; border-radius:12px; 
                      color:var(--text); font-size:1rem;">
      </div>
      
      <!-- Модель -->
      <div style="margin-bottom:1rem;">
        <label style="color:var(--muted); font-size:0.875rem; margin-bottom:0.5rem; display:block;">Модель</label>
        <input type="text" name="model" placeholder="Модель" required 
               style="width:100%; padding:1rem; background:#0d0f12; border:1px solid var(--border); border-radius:12px; 
                      color:white; font-size:1rem;">
      </div>
      
      <!-- Год -->
      <div style="margin-bottom:2rem;">
        <label style="color:var(--muted); font-size:0.875rem; margin-bottom:0.5rem; display:block;">Год</label>
        <input type="number" name="year" placeholder="Год" min="1950" max="2030" required 
               style="width:100%; padding:1rem; background:#0d0f12; border:1px solid var(--border); border-radius:12px; 
                      color:white; font-size:1rem;">
      </div>
      
      <!-- Кнопки -->
      <div style="display:flex; gap:1rem; justify-content:flex-end;">
        <button type="button" id="cancel-car"
                style="padding:0.9rem 1.8rem; background:transparent; border:1px solid #475569; 
                       color:#cbd5e1; border-radius:12px; font-size:1rem; cursor:pointer;">
          Отмена
        </button>
        <button type="submit"
                style="padding:0.9rem 1.8rem; background:var(--primary); color:white; border:none; 
                       border-radius:999px; font-size:1rem; font-weight:600; cursor:pointer;">
          Добавить
        </button>
      </div>
    </form>
  </div>
</div>



</body>
</html>